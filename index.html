<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Elite Label Tracker</title>
  <style>
    /* Default Light Theme */
    body {
      --bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --text: #222;
      --input-bg: #fff;
      --card-bg: rgba(255, 255, 255, 0.95);
      --accent: #4f46e5;
      --accent-hover: #3730a3;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --shadow: rgba(0, 0, 0, 0.1);
      --filter-bg: rgba(255, 255, 255, 0.1); /* */
      --border: rgba(255, 255, 255, 0.2); /* */
      background: var(--bg);
      color: var(--text);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    body.dark {
      --bg: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      --text: #f0f0f0;
      --input-bg: #2d3748;
      --card-bg: rgba(45, 55, 72, 0.95);
      --accent: #6366f1;
      --accent-hover: #4f46e5;
      --shadow: rgba(0, 0, 0, 0.3);
      --filter-bg: rgba(45, 55, 72, 0.3); /* */
      --border: rgba(255, 255, 255, 0.1); /* */
    }

    /* User Info Bar */
    .user-info {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      background: var(--card-bg);
      padding: 10px 20px;
      border-radius: 25px;
      backdrop-filter: blur(10px);
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
      box-shadow: 0 4px 20px var(--shadow);
    }

    .user-avatar {
      width: 30px;
      height: 30px;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
    }

    .user-name {
      font-weight: 600;
      font-size: 14px;
    }

    /* Header Styles */
    .main-header {
      text-align: center;
      padding: 40px 20px 20px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border); /* */
      margin-bottom: 30px;
    }

    .main-title {
      font-size: 3.5rem;
      font-weight: 800;
      background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #f9ca24);
      background-size: 300% 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: gradientShift 4s ease-in-out infinite;
      margin: 0;
      text-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .main-subtitle {
      font-size: 1.2rem;
      margin-top: 10px;
      opacity: 0.9;
      font-weight: 300;
    }

    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    .theme-toggle {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
    }

    .theme-toggle button {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid var(--border); /* */
      color: var(--text);
      backdrop-filter: blur(10px);
      padding: 10px 15px; /* */
      border-radius: 10px; /* */
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .theme-toggle button:hover {
      background: rgba(255, 255, 255, 0.3); /* */
      transform: translateY(-2px);
    }

    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 30px;
      background: var(--card-bg);
      border-radius: 20px;
      box-shadow: 0 20px 40px var(--shadow);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border); /* */
    }

    h2 {
      margin-bottom: 20px;
      font-size: 1.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* Statistics Bar */
    .stats-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--filter-bg);
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }

    .stat-number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent);
      display: block;
    }

    .stat-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-top: 5px;
    }

    /* Tab System */
    .tab-container {
      margin-bottom: 30px;
    }

    .tab-buttons {
      display: flex;
      gap: 5px;
      margin-bottom: 20px;
      background: rgba(0, 0, 0, 0.1);
      padding: 5px;
      border-radius: 15px;
    }

    .tab-btn {
      flex: 1;
      padding: 15px 20px;
      border: none;
      background: transparent;
      color: var(--text);
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .tab-btn.active {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
    }

    .tab-btn:hover:not(.active) {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-1px);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Form Styles */
    label {
      font-weight: 600;
      margin-top: 15px;
      display: block;
      color: var(--text);
    }

    input, select, textarea {
      width: 100%;
      padding: 12px 16px;
      margin-top: 8px;
      border-radius: 10px;
      border: 2px solid var(--border); /* */
      background: var(--input-bg);
      color: var(--text);
      box-sizing: border-box;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
      transform: translateY(-2px);
    }

    button {
      margin-top: 15px;
      padding: 12px 24px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    button:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(79, 70, 229, 0.3);
    }

    .form-grid {
      display: grid;
      grid-template-columns: 200px 1fr;
      gap: 15px 25px;
      align-items: center;
    }

    .form-actions {
      display: flex;
      gap: 15px;
      margin-top: 25px;
    }

    .btn-secondary {
      background: #6b7280;
    }

    .btn-secondary:hover {
      background: #4b5563;
    }

    .btn-danger { /* */
      background: var(--danger);
    }

    .btn-danger:hover { /* */
      background: #dc2626;
    }

    /* Enhanced Filter System */
    .filters {
      background: var(--filter-bg);
      border-radius: 20px;
      padding: 25px;
      margin-bottom: 30px;
      border: 1px solid var(--border);
      backdrop-filter: blur(10px);
    }

    .filters h3 {
      margin: 0 0 20px 0;
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filter-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-label {
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filter-select {
      background: var(--input-bg);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 10px 14px;
      color: var(--text);
      font-size: 14px;
      transition: all 0.3s ease;
      margin-top: 0;
    }

    .filter-select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .multi-select-container { /* */
      position: relative;
    }

    .multi-select-display { /* */
      background: var(--input-bg);
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 10px 14px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 20px;
    }

    .multi-select-display:hover { /* */
      border-color: var(--accent);
    }

    .multi-select-options { /* */
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--card-bg);
      border: 2px solid var(--border);
      border-radius: 10px;
      margin-top: 5px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 100;
      display: none;
      box-shadow: 0 10px 30px var(--shadow);
    }

    .multi-select-options.show { /* */
      display: block;
    }

    .multi-select-option { /* */
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .multi-select-option:hover { /* */
      background: var(--filter-bg);
    }

    .multi-select-option.selected { /* */
      background: var(--accent);
      color: white;
    }

    .selected-tags { /* */
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .selected-tag { /* */
      background: var(--accent);
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .tag-remove { /* */
      cursor: pointer;
      font-weight: bold;
      padding: 0 4px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
    }

    .tag-remove:hover { /* */
      background: rgba(255, 255, 255, 0.4);
    }

    .clear-filters-btn { /* */
      background: #888;
      margin-top: 20px;
      padding: 10px 20px;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .clear-filters-btn:hover { /* */
      background: #666;
    }

    /* Priority Board Styles */
    .priority-board {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-top: 20px;
    }

    .priority-column {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      padding: 20px;
      min-height: 400px;
      border: 2px dashed rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .priority-column.drag-over {
      border-color: var(--accent);
      background: rgba(79, 70, 229, 0.1);
      transform: scale(1.02);
    }

    .priority-column h3 {
      text-align: center;
      margin: 0 0 20px 0;
      padding: 15px;
      border-radius: 10px;
      font-weight: 700;
      font-size: 1.1rem;
    }

    .high-priority-col h3 {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
    }

    .medium-priority-col h3 {
      background: linear-gradient(135deg, #ffa726, #ff9800);
      color: white;
    }

    .low-priority-col h3 {
      background: linear-gradient(135deg, #66bb6a, #4caf50);
      color: white;
    }

    /* Enhanced Card Styles */
    .draggable-card, .label-card {
      background: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      cursor: grab;
      border-left: 5px solid var(--accent);
      transition: all 0.3s ease;
      box-shadow: 0 8px 25px var(--shadow);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
    }

    .draggable-card::before { /* */
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), #4ecdc4);
    }

    .draggable-card:active {
      cursor: grabbing;
    }

    .draggable-card:hover, .label-card:hover { /* */
      transform: translateY(-5px);
      box-shadow: 0 15px 40px var(--shadow);
    }

    .draggable-card.dragging {
      opacity: 0.7;
      transform: rotate(2deg);
      z-index: 1000;
    }

    .card-header { /* */
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border);
    }

    .card-company { /* */
      font-weight: 800;
      font-size: 1.2rem;
      color: var(--accent);
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .card-date { /* */
      font-size: 0.9rem;
      font-weight: 600;
      background: var(--filter-bg);
      padding: 6px 12px;
      border-radius: 20px;
      border: 1px solid var(--border);
    }

    .card-product { /* */
      font-weight: 700;
      color: var(--text);
      margin-bottom: 12px;
      font-size: 1.1rem;
      padding: 8px 0;
    }

    .card-details { /* */
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }

    .card-detail { /* */
      padding: 6px 10px;
      background: var(--filter-bg);
      border-radius: 8px;
      border: 1px solid var(--border);
    }

    .card-detail strong { /* */
      color: var(--accent);
      font-weight: 600;
    }

    .card-notes { /* */
      background: var(--filter-bg);
      padding: 10px;
      border-radius: 8px;
      font-style: italic;
      margin-top: 10px;
      border-left: 3px solid var(--accent);
    }

    .tag { /* */
      display: inline-block;
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 0.85em;
      font-weight: 700;
      margin-top: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .high-priority {
      background: linear-gradient(135deg, #ff6b6b, #ee5a24);
      color: white;
      box-shadow: 0 5px 15px rgba(239, 68, 68, 0.3); /* */
    }

    .medium-priority {
      background: linear-gradient(135deg, #ffa726, #ff9800);
      color: white;
      box-shadow: 0 5px 15px rgba(245, 158, 11, 0.3); /* */
    }

    .low-priority {
      background: linear-gradient(135deg, #66bb6a, #4caf50);
      color: white;
      box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3); /* */
    }

    .editBtn, .deleteBtn {
      margin: 8px 8px 0 0;
      padding: 8px 16px;
      font-size: 0.9em;
      border-radius: 8px;
    }

    .deleteBtn {
      background: var(--danger);
    }

    .deleteBtn:hover {
      background: #dc2626;
    }

    .group-header { /* */
      margin: 25px 0 15px 0;
      padding: 15px 20px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: white;
      border-radius: 20px;
      font-weight: 700;
      text-align: center;
      font-size: 1.3rem;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.3);
    }

    .group-subheader { /* */
      margin: 20px 0 15px 0;
      padding: 15px 20px;
      background: var(--filter-bg);
      border-radius: 15px;
      font-weight: 600;
      font-size: 1.1rem;
      border: 1px solid var(--border);
    }

    .message-error { /* */
      color: var(--danger) !important;
      background: rgba(239, 68, 68, 0.1);
      padding: 15px 20px;
      border-radius: 12px;
      border-left: 4px solid var(--danger);
      margin: 15px 0;
      font-weight: 600;
    }

    .message-success { /* */
      color: var(--success) !important;
      background: rgba(16, 185, 129, 0.1);
      padding: 15px 20px;
      border-radius: 12px;
      border-left: 4px solid var(--success);
      margin: 15px 0;
      font-weight: 600;
    }

    .today-date { /* */
      text-align: center;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 30px;
      padding: 20px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(79, 70, 229, 0.3);
    }

    .bulk-actions { /* */
      margin-top: 20px;
      padding: 20px;
      background: var(--filter-bg);
      border-radius: 15px;
      border: 1px solid var(--border);
      text-align: center;
    }

    .search-bar { /* */
      width: 100%;
      max-width: 400px;
      margin: 0 auto 20px;
      position: relative;
    }

    .search-input { /* */
      width: 100%;
      padding: 12px 20px 12px 45px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      box-sizing: border-box;
    }

    .search-bar::before { /* */
      content: '🔍';
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text);
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <div class="user-info"> <div class="user-avatar" id="userAvatar">A</div>
    <span class="user-name" id="userName">Guest User</span>
  </div>

  <header class="main-header">
    <h1 class="main-title">Elite Label Tracker</h1>
    <p class="main-subtitle">Effortlessly organize and track your product labels</p>
  </header>

  <div class="theme-toggle">
    <button id="themeToggle">☀️ / 🌙</button>
  </div>

  <div class="container">
    <div class="stats-bar"> <div class="stat-card">
        <span class="stat-number" id="totalLabelsStat">0</span>
        <span class="stat-label">Total Labels</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="highPriorityStat">0</span>
        <span class="stat-label">High Priority</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="mediumPriorityStat">0</span>
        <span class="stat-label">Medium Priority</span>
      </div>
      <div class="stat-card">
        <span class="stat-number" id="lowPriorityStat">0</span>
        <span class="stat-label">Low Priority</span>
      </div>
    </div>
  </div>

  <div class="container">
    <h2>➕ Create New Label</h2>
    <div class="form-grid">
      <input type="hidden" id="editMode" />

      <label for="company">🏢 Company</label>
      <select id="company">
        <option value="">Select Company</option>
        <option>AJ Power</option>
        <option>Andor</option>
        <option>Ash</option>
        <option>ATSR</option>
        <option>ABB</option>
        <option>Bodystat</option>
        <option>Camlin</option>
        <option>Caterpillar</option>
        <option>CG/ZIV</option>
        <option>Chubb</option>
        <option>Cardio Phoenix</option>
        <option>Glen</option>
        <option>Heartsine</option>
        <option>Innalabs</option>
        <option>KLAS</option>
        <option>Magstim</option>
        <option>Moocall</option>
        <option>Munster-Simms</option>
        <option>Neurovalens</option>
        <option>Niftylift</option>
        <option>Raidmed</option>
        <option>Raptor</option>
        <option>Sensoteq</option>
        <option>Snorkel</option>
        <option>StableLab</option>
        <option>Statsports</option>
        <option>Terex</option>
        <option>Tharsus</option>
        <option>Vitalograph</option>
        <option>Extra</option>
      </select>

      <label for="date">📅 Date</label>
      <input type="date" id="date" />

      <label for="productCode">🔢 Product Code</label>
      <input type="text" id="productCode" />

      <label for="batchNumber">📦 Batch Number</label>
      <input type="text" id="batchNumber" />

      <label for="serialRange">🔗 Serial Number Range</label>
      <input type="text" id="serialRange" />

      <label for="rev">🔄 Rev</label>
      <input type="text" id="rev" />

      <label for="cn">📋 CN</label>
      <input type="text" id="cn" />

      <label for="weekNumber">📆 Week Number</label>
      <input type="text" id="weekNumber" />

      <label for="quantity">📊 Quantity</label>
      <input type="text" id="quantity" />

      <label for="printedBy">👤 Printed by</label>
      <input type="text" id="printedBy" />

      <label for="notes">📝 Notes</label>
      <input type="text" id="notes" />

      <label for="status">⭐ Priority Level</label>
      <select id="status">
        <option value="High Priority">🔴 High Priority</option>
        <option value="Medium Priority">🟡 Medium Priority</option>
        <option value="Low Priority">🟢 Low Priority</option>
      </select>
    </div>

    <div class="form-actions">
      <button id="saveBtn">💾 Save Label</button>
      <button id="clearBtn" class="btn-secondary">🗑️ Clear Form</button>
    </div>
    <div id="message" style="margin-top: 20px;"></div>
  </div>

  <div class="container tab-container">
    <div class="tab-buttons">
      <button class="tab-btn active" data-tab="list-view">📋 Saved Labels & Filters</button>
      <button class="tab-btn" data-tab="priority-board">🚀 Priority Board</button>
    </div>

    <div id="list-view" class="tab-content active">
      <div class="filters"> <h3><span style="font-size: 1.5em;">🔍</span> Filter Labels</h3>
        <div class="filter-grid"> <div class="filter-group"> <label class="filter-label" for="filterCompany">🏢 Filter by Company</label>
            <div class="multi-select-container"> <div class="multi-select-display" id="multiSelectCompanyDisplay">
                <span class="selected-text">All Companies</span>
                <span class="arrow">▼</span>
              </div>
              <div class="multi-select-options" id="multiSelectCompanyOptions">
                </div>
              <div class="selected-tags" id="selectedCompanyTags"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterMonth">📅 Filter by Month</label>
            <div class="multi-select-container">
              <div class="multi-select-display" id="multiSelectMonthDisplay">
                <span class="selected-text">All Months</span>
                <span class="arrow">▼</span>
              </div>
              <div class="multi-select-options" id="multiSelectMonthOptions">
                </div>
              <div class="selected-tags" id="selectedMonthTags"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="filterStatus">⭐ Filter by Priority</label>
            <div class="multi-select-container">
              <div class="multi-select-display" id="multiSelectStatusDisplay">
                <span class="selected-text">All Priorities</span>
                <span class="arrow">▼</span>
              </div>
              <div class="multi-select-options" id="multiSelectStatusOptions">
                <div class="multi-select-option" data-value="High Priority">🔴 High Priority</div>
                <div class="multi-select-option" data-value="Medium Priority">🟡 Medium Priority</div>
                <div class="multi-select-option" data-value="Low Priority">🟢 Low Priority</div>
              </div>
              <div class="selected-tags" id="selectedStatusTags"></div>
            </div>
          </div>

          <div class="filter-group">
            <label class="filter-label" for="groupByToggle">Grouping</label>
            <input type="checkbox" id="groupByToggle" /> Group by Month & Company
          </div>
        </div>
        <button class="clear-filters-btn" id="clearFiltersBtn">✖️ Clear All Filters</button>
      </div>

      <div class="search-bar"> <input type="text" id="searchInput" class="search-input" placeholder="Search by Product Code, Batch, Notes..." />
      </div>

      <div id="labelPreview">
        </div>
      <div class="bulk-actions"> <button id="clearAllLabelsBtn" class="btn-danger">🗑️ Clear All Labels</button>
      </div>
    </div>

    <div id="priority-board" class="tab-content">
      <p class="today-date" id="todayDate"></p> <div class="priority-board">
        <div class="priority-column high-priority-col" data-priority="High Priority">
          <h3>🔴 High Priority</h3>
        </div>
        <div class="priority-column medium-priority-col" data-priority="Medium Priority">
          <h3>🟡 Medium Priority</h3>
        </div>
        <div class="priority-column low-priority-col" data-priority="Low Priority">
          <h3>🟢 Low Priority</h3>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // Firebase SDK imports - DO NOT CHANGE THESE
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics.js";
    import { getFirestore, collection, addDoc, getDocs, doc, setDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "YOUR_ACTUAL_FIREBASE_API_KEY_HERE", // <--- REPLACE THIS WITH YOUR ACTUAL KEY
      authDomain: "elitelabels-5772f.firebaseapp.com",
      projectId: "elitelabels-5772f",
      storageBucket: "elitelabels-5772f.firebasestorage.app",
      messagingSenderId: "1080571020507",
      appId: "1:1080571020507:web:6400f319b9c6a589a878fe",
      measurementId: "G-YKPQ47W0NS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app); // Initialized but not used for data storage
    const db = getFirestore(app); // Get a reference to the Firestore database
    const labelsCollection = collection(db, "labels"); // Reference to the 'labels' collection

    let labelsDatabase = []; // This will now be populated from Firestore

    const formIds = [
      "company", "date", "productCode", "batchNumber", "serialRange", "rev", "cn",
      "weekNumber", "quantity", "printedBy", "notes", "status"
    ];

    // Multi-select state
    let selectedCompanies = [];
    let selectedMonths = [];
    let selectedStatuses = [];

    const getFormData = () => {
      const data = {};
      formIds.forEach(id => {
        const element = document.getElementById(id);
        data[id] = element ? element.value : "";
      });
      return data;
    };

    const fillForm = (data) => {
      formIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.value = data[id] || "";
        }
      });
      const editModeElement = document.getElementById("editMode");
      if (editModeElement) {
        editModeElement.value = data.id || ""; // Use Firestore document ID as editMode ID
      }
      const statusElement = document.getElementById("status");
      if (statusElement && data.status) {
        statusElement.value = data.status;
      }
    };

    const clearForm = () => {
      formIds.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
          element.value = "";
        }
      });
      const editModeElement = document.getElementById("editMode");
      if (editModeElement) {
        editModeElement.value = "";
      }
      const dateElement = document.getElementById("date");
      if (dateElement) {
        dateElement.valueAsDate = new Date();
      }
      const statusElement = document.getElementById("status");
      if (statusElement) {
        statusElement.value = "High Priority";
      }
      showMessage("");
    };

    function showMessage(msg, isError = false) {
      const el = document.getElementById("message");
      if (el) {
        el.textContent = msg;
        el.className = isError ? "message-error" : "message-success";
        if (msg) {
          setTimeout(() => {
            el.textContent = "";
            el.className = "";
          }, 4000);
        }
      }
    }

    async function saveLabel() {
      const data = getFormData();
      if (!data.company || !data.date || !data.productCode) {
        showMessage("Company, Date, and Product Code are required.", true);
        return;
      }

      const editId = document.getElementById("editMode").value;
      try {
        if (editId) {
          // Update existing document
          const docRef = doc(db, "labels", editId);
          await setDoc(docRef, data);
          showMessage("Label updated successfully!");
        } else {
          // Add new document
          const docRef = await addDoc(labelsCollection, data);
          showMessage("Label saved successfully!");
        }
        clearForm();
        await renderAllViews(); // Re-render to show updated/new labels
      } catch (e) {
        console.error("Error saving label to Firebase:", e);
        showMessage("Failed to save label. Check console for details.", true);
      }
    }

    async function deleteLabel(id) {
      if (!confirm("Are you sure you want to delete this label?")) return;
      try {
        await deleteDoc(doc(db, "labels", id));
        showMessage("Label deleted!");
        await renderAllViews(); // Re-render to show changes
      } catch (e) {
        console.error("Error deleting label from Firebase:", e);
        showMessage("Failed to delete label. Check console for details.", true);
      }
    }

    async function loadLabelsFromFirebase() {
      labelsDatabase = []; // Clear current data before loading
      try {
        const querySnapshot = await getDocs(labelsCollection);
        querySnapshot.forEach((doc) => {
          labelsDatabase.push({ id: doc.id, ...doc.data() });
        });
        showMessage("Labels loaded from Firebase!");
      } catch (e) {
        console.error("Error loading labels from Firebase:", e);
        showMessage("Failed to load labels from Firebase. Starting with empty list. Check console for details.", true);
        labelsDatabase = []; // Ensure empty if loading fails
      }
    }

    // Function to clear all labels
    async function clearAllLabels() {
      if (!confirm("Are you sure you want to delete ALL labels? This action cannot be undone.")) return;
      try {
        const querySnapshot = await getDocs(labelsCollection);
        const deletePromises = [];
        querySnapshot.forEach((docu) => {
          deletePromises.push(deleteDoc(doc(db, "labels", docu.id)));
        });
        await Promise.all(deletePromises); // Wait for all deletions to complete
        labelsDatabase = []; // Clear local array
        showMessage("All labels cleared from Firebase!");
        renderAllViews(); // Re-render to reflect empty state
      } catch (e) {
        console.error("Error clearing all labels from Firebase:", e);
        showMessage("Failed to clear all labels. Check console for details.", true);
      }
    }

    function renderCard(label, draggable = false) {
      const div = document.createElement("div");
      div.className = draggable ? "draggable-card" : "label-card";
      if (draggable) {
        div.setAttribute("draggable", "true");
        div.dataset.id = label.id;
      }
      const statusClass = label.status ? label.status.toLowerCase().replace(/ /g, '-') : 'unknown-priority';
      div.innerHTML = `
        <div class="card-header">
          <span class="card-company">${label.company}</span>
          <span class="card-date">${label.date}</span>
        </div>
        <div class="card-product">Product: ${label.productCode}</div>
        <div class="card-details">
          <div class="card-detail"><strong>Batch:</strong> ${label.batchNumber}</div>
          <div class="card-detail"><strong>Serial:</strong> ${label.serialRange}</div>
          <div class="card-detail"><strong>Rev:</strong> ${label.rev}</div>
          <div class="card-detail"><strong>CN:</strong> ${label.cn}</div>
          <div class="card-detail"><strong>Week:</strong> ${label.weekNumber}</div>
          <div class="card-detail"><strong>Qty:</strong> ${label.quantity}</div>
          <div class="card-detail"><strong>Printed by:</strong> ${label.printedBy}</div>
        </div>
        ${label.notes ? `<div class="card-notes">📝 ${label.notes}</div>` : ''}
        <span class="tag ${statusClass}">${label.status}</span>
        ${!draggable ? `
          <button data-id="${label.id}" class="editBtn">Edit</button>
          <button data-id="${label.id}" class="deleteBtn">Delete</button>
        ` : ''}
      `;
      return div;
    }

    function renderLabels() {
      const preview = document.getElementById("labelPreview");
      if (!preview) return;

      const groupBy = document.getElementById("groupByToggle")?.checked || false;
      const searchQuery = document.getElementById("searchInput")?.value.toLowerCase() || "";

      let filteredLabels = labelsDatabase.filter(l => {
        const matchesCompany = selectedCompanies.length === 0 || selectedCompanies.includes(l.company);
        const matchesMonth = selectedMonths.length === 0 || selectedMonths.includes(l.date.slice(0, 7));
        const matchesStatus = selectedStatuses.length === 0 || selectedStatuses.includes(l.status);
        
        const matchesSearch = searchQuery === "" ||
          (l.productCode && l.productCode.toLowerCase().includes(searchQuery)) ||
          (l.batchNumber && l.batchNumber.toLowerCase().includes(searchQuery)) ||
          (l.notes && l.notes.toLowerCase().includes(searchQuery));

        return matchesCompany && matchesMonth && matchesStatus && matchesSearch;
      });

      filteredLabels.sort((a, b) => new Date(b.date) - new Date(a.date));

      preview.innerHTML = "";

      if (!groupBy) {
        filteredLabels.forEach(label => preview.appendChild(renderCard(label, false)));
      } else {
        const grouped = {};
        filteredLabels.forEach(label => {
          const month = label.date.slice(0, 7);
          const company = label.company;
          if (!grouped[month]) {
            grouped[month] = {};
          }
          if (!grouped[month][company]) {
            grouped[month][company] = [];
          }
          grouped[month][company].push(label);
        });

        for (const month in grouped) {
          const monthHeader = document.createElement("h4");
          monthHeader.className = "group-header";
          monthHeader.textContent = new Date(month).toLocaleString('default', { year: 'numeric', month: 'long' });
          preview.appendChild(monthHeader);

          for (const company in grouped[month]) {
            const companyHeader = document.createElement("h5");
            companyHeader.className = "group-subheader";
            companyHeader.textContent = company;
            preview.appendChild(companyHeader);

            grouped[month][company].forEach(label => preview.appendChild(renderCard(label, false)));
          }
        }
      }
      updateStats();
    }

    function renderPriorityBoard() {
      const highCol = document.querySelector(".high-priority-col");
      const mediumCol = document.querySelector(".medium-priority-col");
      const lowCol = document.querySelector(".low-priority-col");

      if (!highCol || !mediumCol || !lowCol) return;

      highCol.innerHTML = `<h3>🔴 High Priority</h3>`;
      mediumCol.innerHTML = `<h3>🟡 Medium Priority</h3>`;
      lowCol.innerHTML = `<h3>🟢 Low Priority</h3>`;

      labelsDatabase.forEach(label => {
        const card = renderCard(label, true);
        if (label.status === "High Priority") {
          highCol.appendChild(card);
        } else if (label.status === "Medium Priority") {
          mediumCol.appendChild(card);
        } else {
          lowCol.appendChild(card);
        }
      });
      addDragAndDropListeners();
      updateTodayDate();
      updateStats();
    }

    function updateTodayDate() {
      const today = new Date();
      const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const todayDateElement = document.getElementById("todayDate");
      if (todayDateElement) {
        todayDateElement.textContent = `Today: ${today.toLocaleDateString(undefined, options)}`;
      }
    }

    function updateStats() {
      document.getElementById('totalLabelsStat').textContent = labelsDatabase.length;
      document.getElementById('highPriorityStat').textContent = labelsDatabase.filter(l => l.status === 'High Priority').length;
      document.getElementById('mediumPriorityStat').textContent = labelsDatabase.filter(l => l.status === 'Medium Priority').length;
      document.getElementById('lowPriorityStat').textContent = labelsDatabase.filter(l => l.status === 'Low Priority').length;
    }

    async function renderAllViews() {
      await loadLabelsFromFirebase(); // Ensure labels are loaded before rendering
      renderLabels();
      renderPriorityBoard();
      generateCompanyMultiSelectOptions(document.getElementById('multiSelectCompanyOptions'));
      generateMonthMultiSelectOptions(document.getElementById('multiSelectMonthOptions'));
      updateMultiSelectDisplay('Company', selectedCompanies);
      updateMultiSelectDisplay('Month', selectedMonths);
      updateMultiSelectDisplay('Status', selectedStatuses);
    }

    // Drag and Drop functionality
    let draggedCard = null;

    function addDragAndDropListeners() {
      document.querySelectorAll(".draggable-card").forEach(card => {
        card.addEventListener("dragstart", (e) => {
          draggedCard = card;
          e.dataTransfer.setData("text/plain", card.dataset.id);
          card.classList.add("dragging");
        });

        card.addEventListener("dragend", () => {
          draggedCard.classList.remove("dragging");
          draggedCard = null;
        });
      });

      document.querySelectorAll(".priority-column").forEach(column => {
        column.addEventListener("dragover", (e) => {
          e.preventDefault();
          column.classList.add("drag-over");
        });

        column.addEventListener("dragleave", (e) => {
          column.classList.remove("drag-over");
        });

        column.addEventListener("drop", async (e) => {
          e.preventDefault();
          column.classList.remove("drag-over");
          const id = e.dataTransfer.getData("text/plain");
          const labelIndex = labelsDatabase.findIndex(label => label.id === id);

          if (labelIndex !== -1) {
            const newStatus = column.dataset.priority;
            const updatedLabel = { ...labelsDatabase[labelIndex], status: newStatus };
            try {
              const docRef = doc(db, "labels", id);
              await setDoc(docRef, updatedLabel); // Update status in Firebase
              showMessage("Label priority updated!");
              await renderAllViews(); // Re-render to reflect changes
            } catch (error) {
              console.error("Error updating priority in Firebase:", error);
              showMessage("Failed to update priority. Check console for details.", true);
            }
          }
        });
      });
    }

    // Multi-select logic
    function setupMultiSelect(type, displayId, optionsId, selectedArray, generateOptionsFn) {
      const display = document.getElementById(displayId);
      const optionsContainer = document.getElementById(optionsId);
      const selectedTagsContainer = document.getElementById(`selected${type}Tags`);

      if (display) {
        display.addEventListener('click', (e) => {
          e.stopPropagation(); // Prevent closing if clicking on display
          optionsContainer.classList.toggle('show');
        });
      }

      if (optionsContainer) {
        optionsContainer.addEventListener('click', (e) => {
          if (e.target.classList.contains('multi-select-option')) {
            const value = e.target.dataset.value;
            const index = selectedArray.indexOf(value);
            if (index > -1) {
              selectedArray.splice(index, 1); // Remove if already selected
              e.target.classList.remove('selected');
            } else {
              selectedArray.push(value); // Add if not selected
              e.target.classList.add('selected');
            }
            updateMultiSelectDisplay(type, selectedArray);
            renderLabels(); // Re-render labels on filter change
          }
        });
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (display && optionsContainer && !display.contains(e.target) && !optionsContainer.contains(e.target)) {
          optionsContainer.classList.remove('show');
        }
      });
      
      // Initial population
      if (generateOptionsFn) {
        generateOptionsFn(optionsContainer);
      }
    }

    function updateMultiSelectDisplay(type, selectedArray) {
      const display = document.getElementById(`multiSelect${type}Display`);
      const selectedTagsContainer = document.getElementById(`selected${type}Tags`);
      if (!display || !selectedTagsContainer) return;

      selectedTagsContainer.innerHTML = '';
      if (selectedArray.length === 0) {
        display.querySelector('.selected-text').textContent = `All ${type}s`;
      } else {
        display.querySelector('.selected-text').textContent = `${selectedArray.length} Selected`;
        selectedArray.forEach(tag => {
          const span = document.createElement('span');
          span.className = 'selected-tag';
          span.textContent = tag;
          const removeBtn = document.createElement('span');
          removeBtn.className = 'tag-remove';
          removeBtn.textContent = 'x';
          removeBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent toggling dropdown
            const index = selectedArray.indexOf(tag);
            if (index > -1) {
              selectedArray.splice(index, 1);
              document.querySelector(`#multiSelect${type}Options .multi-select-option[data-value="${tag}"]`)?.classList.remove('selected');
              updateMultiSelectDisplay(type, selectedArray);
              renderLabels();
            }
          });
          span.appendChild(removeBtn);
          selectedTagsContainer.appendChild(span);
        });
      }
    }

    function generateCompanyMultiSelectOptions(optionsContainer) {
      const companies = [...new Set(labelsDatabase.map(label => label.company))].sort();
      optionsContainer.innerHTML = '';
      companies.forEach(company => {
        const div = document.createElement('div');
        div.className = 'multi-select-option';
        div.dataset.value = company;
        div.textContent = company;
        if (selectedCompanies.includes(company)) {
          div.classList.add('selected');
        }
        optionsContainer.appendChild(div);
      });
    }

    function generateMonthMultiSelectOptions(optionsContainer) {
      const months = [...new Set(labelsDatabase.map(label => label.date.slice(0, 7)))].sort();
      optionsContainer.innerHTML = '';
      months.forEach(month => {
        const div = document.createElement('div');
        div.className = 'multi-select-option';
        div.dataset.value = month;
        div.textContent = new Date(month + "-01").toLocaleString('default', { year: 'numeric', month: 'long' });
        if (selectedMonths.includes(month)) {
          div.classList.add('selected');
        }
        optionsContainer.appendChild(div);
      });
    }

    function clearAllFilters() {
        selectedCompanies = [];
        selectedMonths = [];
        selectedStatuses = [];
        document.getElementById("searchInput").value = "";
        document.getElementById("groupByToggle").checked = false;
        renderAllViews();
    }

    // User Name Functionality
    function initializeUserName() {
      let userName = localStorage.getItem('userName');
      if (!userName) {
        userName = prompt("Welcome! Please enter your name to personalize your tracker:");
        if (userName) {
          localStorage.setItem('userName', userName);
        } else {
          userName = "Guest User"; // Default if user cancels or enters nothing
        }
      }
      document.getElementById('userName').textContent = userName;
      document.getElementById('userAvatar').textContent = userName.charAt(0).toUpperCase();
    }

    document.addEventListener("DOMContentLoaded", async () => {
      initializeUserName();

      // Theme toggle
      const themeToggleBtn = document.getElementById("themeToggle");
      themeToggleBtn.addEventListener("click", () => {
        document.body.classList.toggle("dark");
        const isDarkMode = document.body.classList.contains("dark");
        localStorage.setItem("theme", isDarkMode ? "dark" : "light");
      });

      const savedTheme = localStorage.getItem("theme");
      if (savedTheme === "dark") {
        document.body.classList.add("dark");
      } else {
        document.body.classList.remove("dark");
      }

      clearForm(); // Auto fill date and set default status

      // Event listeners
      const saveBtn = document.getElementById("saveBtn");
      const clearBtn = document.getElementById("clearBtn");
      if (saveBtn) saveBtn.addEventListener("click", saveLabel);
      if (clearBtn) clearBtn.addEventListener("click", clearForm);

      // Clear All Labels button
      const clearAllLabelsButton = document.getElementById("clearAllLabelsBtn");
      if (clearAllLabelsButton) {
        clearAllLabelsButton.addEventListener("click", clearAllLabels);
      }

      // Edit and delete button handlers (delegated to document for dynamic elements)
      document.addEventListener("click", async (e) => {
        if (e.target.classList.contains("editBtn")) {
          const id = e.target.dataset.id;
          const labelToEdit = labelsDatabase.find(label => label.id === id);
          if (labelToEdit) {
            fillForm(labelToEdit);
          }
        }
        if (e.target.classList.contains("deleteBtn")) {
          await deleteLabel(e.target.dataset.id);
        }
      });

      // Filter change handlers
      document.getElementById("groupByToggle")?.addEventListener("change", renderLabels);
      document.getElementById("searchInput")?.addEventListener("input", renderLabels);
      document.getElementById("clearFiltersBtn")?.addEventListener("click", clearAllFilters);


      // Multi-select initialization
      setupMultiSelect('Company', 'multiSelectCompanyDisplay', 'multiSelectCompanyOptions', selectedCompanies, generateCompanyMultiSelectOptions);
      setupMultiSelect('Month', 'multiSelectMonthDisplay', 'multiSelectMonthOptions', selectedMonths, generateMonthMultiSelectOptions);
      setupMultiSelect('Status', 'multiSelectStatusDisplay', 'multiSelectStatusOptions', selectedStatuses, null);

      // Tab functionality
      document.querySelectorAll(".tab-btn").forEach(button => {
        button.addEventListener("click", () => {
          document.querySelectorAll(".tab-btn").forEach(btn => btn.classList.remove("active"));
          document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));

          button.classList.add("active");
          const targetTab = button.dataset.tab;
          document.getElementById(targetTab).classList.add("active");

          // Re-render relevant content when tab is switched
          if (targetTab === "list-view") {
            renderLabels();
          } else if (targetTab === "priority-board") {
            renderPriorityBoard();
          }
        });
      });

      // Initial render for all views
      await renderAllViews();
    });
  </script>
</body>
</html>